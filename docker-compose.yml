services:
  cyber-triage:
    image: cyber-triage:latest
    build:
      context: .
      dockerfile: Dockerfile

    container_name: cyber-triage

    restart: unless-stopped

    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CYBERHAVEN_API_KEY=${CYBERHAVEN_API_KEY}
      - CYBERHAVEN_API_URL=${CYBERHAVEN_API_URL:-https://payclip.cyberhaven.io/public}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-west-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-clip-cyberhaven-upload}
      - INCIDENTS_DIR=./data/incidents
      - SCAN_INTERVAL_MINUTES=${SCAN_INTERVAL_MINUTES:-30}
      - HOURS_BACK=${HOURS_BACK:-24}
      - MAX_ANALYSIS_PER_CYCLE=${MAX_ANALYSIS_PER_CYCLE:-10}
      - CLEANUP_DAYS=${CLEANUP_DAYS:-30}
      - PYTHONUNBUFFERED=1

    volumes:
      - ./data:/home/cybertriage/app/data
      - ./logs:/home/cybertriage/app/logs
      - ./prompts:/home/cybertriage/app/prompts:ro

    networks:
      - cyber-triage-net

    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "from db_manager import DatabaseManager; DatabaseManager()",
        ]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  cyber-triage-net:
    driver: bridge
